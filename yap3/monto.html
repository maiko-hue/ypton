<!DOCTYPE html>
<html lang="es">
<head>
    <script type="module" src="seguridad.js"></script>
    <script>
    if (!localStorage.getItem('sesion_iniciada')) {
        window.location.href = 'index.html';
    }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yapear Monto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --brand-purple: #742284; --brand-lilac: #bfaec4; --brand-active-lilac: #a86cc1; --brand-teal: #00BFA5; --text-gray: #666; --bg-gray: #f9f9f9; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { width: 100%; height: 100dvh; overflow: hidden; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: white; color: #333; }
        .container { width: 100%; height: 100dvh; display: flex; flex-direction: column; position: relative; background-color: white; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; flex-shrink: 0; }
        .back-btn { display: flex; align-items: center; text-decoration: none; color: #444; font-weight: 700; font-size: 17px; }
        .back-btn i { margin-right: 10px; color: #666; font-size: 18px; }
        .close-btn { color: #666; font-size: 26px; text-decoration: none; font-weight: bold; }
        .content { flex: 1; display: flex; flex-direction: column; align-items: center; padding-top: 20px; overflow-y: auto; min-height: 0; }
        
        /* --- ESTILOS SKELETON --- */
        .skeleton-box {
            width: 140px;
            height: 18px;
            background-color: #e2e5e7;
            border-radius: 6px;
            margin-bottom: 2px;
            position: relative;
            overflow: hidden;
        }
        .skeleton-box::after {
            content: "";
            position: absolute;
            top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 100% { left: 200%; } }

        /* El input inicia oculto mientras carga el skeleton */
        .recipient-name { font-size: 22px; font-weight: 700; color: var(--brand-purple); border: none; text-align: center; background: transparent; width: 100%; margin-bottom: 2px; font-family: inherit; display: none; }
        
        .recipient-number { font-size: 15px; color: #888; font-weight: 600; margin-bottom: 40px; letter-spacing: 1px; }
        .amount-wrapper { display: flex; align-items: center; justify-content: center; margin-bottom: 15px; width: 100%; }
        .currency-symbol { font-size: 45px; font-weight: 500; color: var(--brand-lilac); margin-right: 5px; margin-bottom: 8px; transition: #E3B2EC; }
        .amount-input { font-size: 85px; font-weight: 500; color: var(--brand-purple); border: none; width: 1ch; text-align: left; background: transparent; font-family: inherit; line-height: 1; padding: 0; caret-color: var(--brand-purple); }
        .amount-input::placeholder { color: #742284; }
        .limit-text { background-color: #f4f4f4; color: #888; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; text-align: center; margin: 0 20px 20px 20px; }
        .bottom-section { width: 100%; padding-bottom: max(60px, env(safe-area-inset-bottom)); flex-shrink: 0; background-color: white; z-index: 10; }
        .message-container { width: 100%; padding: 0 25px; position: relative; }
        .message-input { width: 100%; border: none; text-align: center; font-size: 16px; color: #333; font-family: inherit; padding-bottom: 15px; background: transparent; }
        .message-input::placeholder { color: #aaa; }
        .divider-line { width: 90%; height: 1px; background-color: #e0e0e0; margin: 0 auto 20px auto; }
        .footer { padding: 0 20px; display: flex; gap: 15px; background-color: white; }
        .btn { flex: 1; padding: 16px; border-radius: 8px; font-weight: 700; font-size: 16px; cursor: pointer; text-align: center; border: none; transition: all 0.2s; }
        .btn-outline { background-color: white; border: 1px solid var(--brand-teal); color: var(--brand-teal); }
        .btn-primary { background-color: #e0e0e0; color: white; pointer-events: none; }
        .btn-primary.active { background-color: var(--brand-teal); color: white; pointer-events: all; box-shadow: 0 4px 12px rgba(0, 191, 165, 0.3); }
        .btn-primary.active:active { transform: scale(0.98); }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background-color: rgba(0,0,0,0.6); z-index: 3000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .loader-overlay.show { opacity: 1; pointer-events: all; }
        .loader-card { background: white; width: 273px; height: 117px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .custom-spinner { width: 38px; height: 38px; border: 4px solid #e0e0e0; border-top: 4px solid var(--brand-teal); border-radius: 50%; animation: spin 1.5s linear infinite; margin-bottom: 12px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-text { font-size: 16px; font-weight: 700; color: #333; }

        /* --- ESTILOS NUEVOS: MODALES BOTTOM SHEET --- */
        .bottom-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 92dvh;
            background: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            padding: 20px;
        }
        .loader-overlay.show .bottom-sheet {
            transform: translateY(0);
        }
        .modal-header-nav {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-shrink: 0;
        }
        .modal-back-title {
            display: flex; align-items: center; color: #1a1a1a; font-weight: 700; font-size: 17px; cursor: pointer;
        }
        .modal-back-title i { margin-right: 15px; font-size: 18px; color: #555; }
        .modal-close-icon { cursor: pointer; display: flex; justify-content: center; align-items: center; width: 24px; height: 24px; }
        
        /* Lista de Bancos */
        .bank-list-scroll { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .bank-item {
            display: flex; align-items: center;
            border: 1px solid #f2f2f2; border-radius: 10px;
            padding: 14px 16px; margin-bottom: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); /* Sombra aumentada */
            cursor: pointer; background: white; transition: background-color 0.2s;
        }
        .bank-item:active { background-color: #fafafa; }
        .bank-item-icon {
            width: 34px; height: 34px; border-radius: 50%;
            background-color: #F7E1F8; display: flex; justify-content: center; align-items: center;
            margin-right: 15px; flex-shrink: 0;
        }
        .bank-item-icon img { width: 18px; height: 18px; object-fit: contain; }
        .bank-item-text { font-size: 15px; font-weight: 500; color: #1a1a1a; }
        
        .subtitle-banks { color: var(--brand-purple); font-weight: 700; font-size: 14px; margin: 25px 0 15px 5px; }

        /* Confirmación de Banco */
        .confirm-summary {
            background-color: #f7f7f9; width: 100%; border-radius: 12px; padding: 20px;
            display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;
        }
        .summary-row { display: flex; justify-content: space-between; font-size: 14.5px; }
        .summary-label { color: #666; }
        .summary-val { font-weight: 700; color: #1a1a1a; }
        
        /* Checkbox Personalizado */
        .custom-checkbox-container { display: flex; align-items: center; background: white; border: 1px solid #f0f0f0; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); cursor: pointer; }
        .custom-checkbox-container input { accent-color: var(--brand-teal); width: 22px; height: 22px; margin-right: 12px; cursor: pointer; }
        .custom-checkbox-container span { font-size: 14.5px; color: #333; font-weight: 400; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="yapear.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> Yapear a</a>
            <a href="inicio.html" class="close-btn"><i class="fa-solid fa-xmark"></i></a>
        </div>
        <div class="content">
            <div id="nameSkeleton" class="skeleton-box"></div>
            <input type="text" id="recipientName" class="recipient-name" spellcheck="false">
            
            <div class="recipient-number" id="maskedNumber">*** *** ...</div>
            <div class="amount-wrapper">
                <span class="currency-symbol" id="currencySymbol">S/</span>
                <input type="text" id="amountInput" class="amount-input" placeholder="0" maxlength="7" inputmode="decimal">
            </div>
            <div class="limit-text">Límite por yapeo S/500, límite por día S/2,000</div>
        </div>
        <div class="bottom-section">
            <div class="message-container"><input type="text" class="message-input" placeholder="Agregar mensaje"></div>
            <div class="divider-line"></div>
            <div class="footer">
                <button class="btn btn-outline" id="otrosBancosBtn">Otros bancos</button>
                <button class="btn btn-primary" id="yapearBtn">Yapear</button>
            </div>
        </div>
    </div>
    
    <div class="loader-overlay" id="loaderModal">
        <div class="loader-card"><div class="custom-spinner"></div><div class="loader-text">Yapeando...</div></div>
    </div>

    <div class="loader-overlay" id="banksOverlay">
        <div class="bottom-sheet">
            <div class="modal-header-nav">
                <div class="modal-back-title close-banks-modal">
                    <i class="fa-solid fa-chevron-left"></i> Yapear a
                </div>
                <div class="modal-close-icon close-banks-modal">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            
            <div class="bank-list-scroll">
                <div class="bank-item" data-banco="Yape">
                    <div class="bank-item-icon" style="background: transparent;">
                        <img src="img/icon-96x96.png" style="width:34px; height:34px; border-radius:50%;" alt="Yape">
                    </div>
                    <div class="bank-item-text" style="font-weight: 700;">Yape</div>
                </div>

                <div class="subtitle-banks">Selecciona una entidad financiera</div>

                <div class="bank-item" data-banco="Plin">
                    <div class="bank-item-icon"><img src="img/arrows.svg" alt=""></div><div class="bank-item-text">Plin</div>
                </div>
                <div class="bank-item" data-banco="Bim">
                    <div class="bank-item-icon"><img src="img/arrows.svg" alt=""></div><div class="bank-item-text">Bim</div>
                </div>
                <div class="bank-item" data-banco="Tunki">
                    <div class="bank-item-icon"><img src="img/arrows.svg" alt=""></div><div class="bank-item-text">Tunki</div>
                </div>
                <div class="bank-item" data-banco="Agora / Oh!">
                    <div class="bank-item-icon"><img src="img/arrows.svg" alt=""></div><div class="bank-item-text">Agora / Oh!</div>
                </div>
                <div class="bank-item" data-banco="BCP">
                    <div class="bank-item-icon"><img src="img/arrows.svg" alt=""></div><div class="bank-item-text">BCP</div>
                </div>
                <div class="bank-item" data-banco="BBVA">
                    <div class="bank-item-icon"><img src="img/arrows.svg" alt=""></div><div class="bank-item-text">BBVA</div>
                </div>
                <div class="bank-item" data-banco="Interbank">
                    <div class="bank-item-icon"><img src="img/arrows.svg" alt=""></div><div class="bank-item-text">Interbank</div>
                </div>
                <div class="bank-item" data-banco="Financiera Efectiva">
                    <div class="bank-item-icon"><img src="img/arrows.svg" alt=""></div><div class="bank-item-text">Financiera Efectiva</div>
                </div>
                <div class="bank-item" data-banco="Dale">
                    <div class="bank-item-icon"><img src="img/arrows.svg" alt=""></div><div class="bank-item-text">Dale</div>
                </div>
                <div class="bank-item" data-banco="IziPay">
                    <div class="bank-item-icon"><img src="img/arrows.svg" alt=""></div><div class="bank-item-text">IziPay</div>
                </div>
            </div>
        </div>
    </div>

    <div class="loader-overlay" id="confirmBankOverlay">
        <div class="bottom-sheet" style="height: auto; max-height: 95dvh;">
            <div class="modal-header-nav">
                <div class="modal-back-title close-confirm-modal">
                    <i class="fa-solid fa-chevron-left"></i> Yapear a
                </div>
                <div class="modal-close-icon close-confirm-modal">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>

            <div style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; padding-top: 10px;">
                <div class="bank-item-icon" style="width: 52px; height: 52px; margin-right: 0; margin-bottom: 12px;">
                    <img src="img/arrows.svg" style="width: 28px; height: 28px;" alt="">
                </div>
                <div style="color: #666; font-size: 15px; margin-bottom: 5px;">Vas a yapear a:</div>
                <div id="confirmNameExact" style="color: var(--brand-purple); font-weight: 700; font-size: 19px; margin-bottom: 25px; text-align: center;">Nombre Exacto</div>

                <div class="confirm-summary">
                    <div class="summary-row">
                        <span class="summary-label">Monto:</span>
                        <span id="confirmAmountTxt" class="summary-val">S/ 0.00</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Destino:</span>
                        <span id="confirmDestinoTxt" class="summary-val">Banco</span>
                    </div>
                </div>

                <div style="width: 100%; margin-top: 15px;">
                    <div id="accordionHeader" style="display: flex; justify-content: flex-end; align-items: center; color: #555; font-size: 14px; cursor: pointer;">
                        Más opciones <i id="accordionIcon" class="fa-solid fa-chevron-down" style="margin-left: 8px;"></i>
                    </div>
                    <div id="accordionContent" style="display: none; margin-top: 15px;">
                        <label class="custom-checkbox-container">
                            <input type="checkbox" id="showPhoneCheckbox">
                            <span>Mostrar Nro. Celular</span>
                        </label>
                    </div>
                </div>
                
                <div style="width: 100%; margin-top: 30px; padding-bottom: 10px;">
                    <button class="btn btn-primary active" id="confirmarOtroBancoBtn" style="width: 100%; margin-bottom: 12px;">CONFIRMAR YAPEO</button>
                    <button class="btn btn-outline close-confirm-modal" style="width: 100%; border-color: #ddd; color: #666;">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, doc, getDoc } from './firebase.js';

        const params = new URLSearchParams(window.location.search);
        let rawNumber = params.get('numero');
        let passedName = params.get('nombre');
        let qrData = params.get('qr_data');

        const maskedNumberEl = document.getElementById('maskedNumber');
        const nameInput = document.getElementById('recipientName');
        const nameSkeleton = document.getElementById('nameSkeleton');

        function displayLoadedName(name) {
            nameInput.value = name;
            nameSkeleton.style.display = 'none';
            nameInput.style.display = 'block';
        }

        async function loadContactData() {
            if (qrData) {
                try {
                    const safeId = qrData.replace(/\//g, '_slash_');
                    const docRef = doc(db, "codigos_qr", safeId);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        displayLoadedName(data.nombre);
                        maskedNumberEl.textContent = data.destino || "Yape"; 
                    } else {
                        displayLoadedName("Negocio QR");
                        maskedNumberEl.textContent = "Yape";
                    }
                } catch (error) {
                    displayLoadedName("Error QR");
                }
                return;
            }
            
            if (!rawNumber) rawNumber = "999999999";
            const lastThree = rawNumber.slice(-3);
            maskedNumberEl.textContent = `*** *** ${lastThree}`;

            if (passedName) {
                displayLoadedName(decodeURIComponent(passedName));
            } else {
                try {
                    const docRef = doc(db, "usuarios_yape", rawNumber);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        displayLoadedName(docSnap.data().nombre);
                    } else {
                        displayLoadedName("Desconocido");
                    }
                } catch (error) { 
                    displayLoadedName("Error de Red"); 
                }
            }
        }
        loadContactData();

        // INTERFAZ ORIGINAL
        const amountInput = document.getElementById('amountInput');
        const yapearBtn = document.getElementById('yapearBtn');
        const currencySymbol = document.getElementById('currencySymbol');
        const loaderModal = document.getElementById('loaderModal');

        function getCurrentDateTime() {
            const now = new Date();
            const dateOptions = { day: 'numeric', month: 'short', year: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
            let dateStr = now.toLocaleDateString('es-ES', dateOptions);
            if (!dateStr.endsWith('.')) {
                const parts = dateStr.split(' ');
                if(parts.length >= 2 && !parts[1].includes('.')) parts[1] += '.';
                dateStr = parts.join(' ');
            }
            let timeStr = now.toLocaleTimeString('en-US', timeOptions).toLowerCase().replace('pm', 'p. m.').replace('am', 'a. m.');
            return { date: dateStr, time: timeStr, full: `${dateStr} - ${timeStr}` };
        }

        amountInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/[^0-9.]/g, ''); 
            if ((val.match(/\./g) || []).length > 1) val = val.substring(0, val.length - 1);
            if (val.length > 1 && val.startsWith('0') && val[1] !== '.') val = val.substring(1);
            let numVal = parseFloat(val);
            if (numVal > 500) val = "500";
            e.target.value = val;
            if (val === "") e.target.style.width = "1ch";
            else e.target.style.width = val.length + "ch";
            if (val.length > 0 && parseFloat(val) > 0) {
                yapearBtn.classList.add('active'); currencySymbol.style.color = '#a86cc1';
            } else {
                yapearBtn.classList.remove('active'); currencySymbol.style.color = '#bfaec4';
            }
        });

        // FUNCIONALIDAD ORIGINAL YAPEAR
        yapearBtn.addEventListener('click', () => {
            loaderModal.classList.add('show');
            const montoFinal = amountInput.value;
            const nombreFinal = nameInput.value;
            const mensajeInput = document.querySelector('.message-input'); 
            const mensajeFinal = mensajeInput ? mensajeInput.value : '';
            const dateTime = getCurrentDateTime();
            const operacionRandom = Math.floor(10000000 + Math.random() * 90000000).toString();
            const codigoSeguridadRandom = Math.floor(100 + Math.random() * 900).toString();

            let destinoReal = "Yape";
            let esQrLogica = "false";
            if (qrData) {
                destinoReal = maskedNumberEl.textContent;
                esQrLogica = "true";
            }

            let tipoMovimiento = 'gasto';
            if (mensajeFinal.trim() === "Auto") tipoMovimiento = 'ingreso';

            let saldoActual = localStorage.getItem('yape_balance') || "1200.00"; 
            let saldoNumerico = parseFloat(saldoActual.replace(/,/g, ''));
            let montoRestar = parseFloat(montoFinal);
            if (!isNaN(saldoNumerico) && !isNaN(montoRestar)) {
                if(tipoMovimiento === 'ingreso') saldoNumerico += montoRestar;
                else saldoNumerico -= montoRestar;
                localStorage.setItem('yape_balance', saldoNumerico.toFixed(2));
            }

            const nuevoMovimiento = {
                nombre: nombreFinal, monto: montoFinal, fecha: dateTime.full,
                fechaSolo: dateTime.date, horaSolo: dateTime.time,
                numero: esQrLogica === "true" ? destinoReal : rawNumber,
                operacion: operacionRandom, codigo: codigoSeguridadRandom,
                mensaje: mensajeFinal, destino: destinoReal, tipo: tipoMovimiento,
                mostrar_celular: "asteriscos" // <--- AÑADIDO PARA YAPE NORMAL
            };

            let movimientos = JSON.parse(localStorage.getItem('yape_movements')) || [];
            movimientos.unshift(nuevoMovimiento);
            localStorage.setItem('yape_movements', JSON.stringify(movimientos));

            setTimeout(() => {
                let url = `exito.html?monto=${montoFinal}&nombre=${encodeURIComponent(nombreFinal)}&destino=${encodeURIComponent(destinoReal)}&es_qr=${esQrLogica}&numero=${rawNumber}&mensaje=${encodeURIComponent(mensajeFinal)}&operacion=${operacionRandom}&codigo=${codigoSeguridadRandom}&fecha=${dateTime.date.replace(/\./g,'')}&hora=${dateTime.time.replace(/\./g,'')}`;
                if (tipoMovimiento === 'ingreso') url += '&tipo=ingreso';
                window.location.href = url;
            }, 3000);
        });

        // --- NUEVA LÓGICA: OTROS BANCOS ---
        const otrosBancosBtn = document.getElementById('otrosBancosBtn');
        const banksOverlay = document.getElementById('banksOverlay');
        const confirmBankOverlay = document.getElementById('confirmBankOverlay');
        let bancoSeleccionado = "";

        // Abrir lista de bancos solo si hay monto
        otrosBancosBtn.addEventListener('click', () => {
            if(parseFloat(amountInput.value) > 0) {
                banksOverlay.classList.add('show');
            }
        });

        // Cerrar lista de bancos
        document.querySelectorAll('.close-banks-modal').forEach(btn => {
            btn.addEventListener('click', () => banksOverlay.classList.remove('show'));
        });

        // Cerrar modal confirmación y regresar
        document.querySelectorAll('.close-confirm-modal').forEach(btn => {
            btn.addEventListener('click', () => confirmBankOverlay.classList.remove('show'));
        });

        // Seleccionar un Banco
        document.querySelectorAll('.bank-item').forEach(item => {
            item.addEventListener('click', () => {
                bancoSeleccionado = item.getAttribute('data-banco');
                
                // Llenar datos de la confirmación
                document.getElementById('confirmDestinoTxt').textContent = bancoSeleccionado;
                document.getElementById('confirmAmountTxt').textContent = "S/ " + parseFloat(amountInput.value).toFixed(2);
                document.getElementById('confirmNameExact').textContent = nameInput.value; // NOMBRE EXACTO INTACTO
                
                // Resetear acordeón y checkbox
                document.getElementById('accordionContent').style.display = 'none';
                document.getElementById('accordionIcon').className = 'fa-solid fa-chevron-down';
                document.getElementById('showPhoneCheckbox').checked = false;

                // Transición de modales
                banksOverlay.classList.remove('show');
                confirmBankOverlay.classList.add('show');
            });
        });

        // Acordeón "Más opciones"
        const accHeader = document.getElementById('accordionHeader');
        const accContent = document.getElementById('accordionContent');
        const accIcon = document.getElementById('accordionIcon');
        
        accHeader.addEventListener('click', () => {
            if(accContent.style.display === 'none') {
                accContent.style.display = 'block';
                accIcon.className = 'fa-solid fa-chevron-up';
            } else {
                accContent.style.display = 'none';
                accIcon.className = 'fa-solid fa-chevron-down';
            }
        });

        // Confirmar Yapeo a Otro Banco
        document.getElementById('confirmarOtroBancoBtn').addEventListener('click', () => {
            confirmBankOverlay.classList.remove('show');
            loaderModal.classList.add('show');

            const montoFinal = amountInput.value;
            const nombreFinal = nameInput.value; // Se va con el nombre exacto
            const mensajeInput = document.querySelector('.message-input'); 
            const mensajeFinal = mensajeInput ? mensajeInput.value : '';
            const dateTime = getCurrentDateTime();
            const operacionRandom = Math.floor(10000000 + Math.random() * 90000000).toString();
            const codigoSeguridadRandom = Math.floor(100 + Math.random() * 900).toString();

            // Parámetros específicos para Otros Bancos
            let destinoReal = bancoSeleccionado;
            let esQrLogica = "false"; // Por número de cel
            let mostrarCelular = document.getElementById('showPhoneCheckbox').checked ? "true" : "false";

            let tipoMovimiento = 'gasto';
            if (mensajeFinal.trim() === "Auto") tipoMovimiento = 'ingreso';

            let saldoActual = localStorage.getItem('yape_balance') || "1200.00"; 
            let saldoNumerico = parseFloat(saldoActual.replace(/,/g, ''));
            let montoRestar = parseFloat(montoFinal);
            if (!isNaN(saldoNumerico) && !isNaN(montoRestar)) {
                if(tipoMovimiento === 'ingreso') saldoNumerico += montoRestar;
                else saldoNumerico -= montoRestar;
                localStorage.setItem('yape_balance', saldoNumerico.toFixed(2));
            }

            const nuevoMovimiento = {
                nombre: nombreFinal, monto: montoFinal, fecha: dateTime.full,
                fechaSolo: dateTime.date, horaSolo: dateTime.time,
                numero: rawNumber, operacion: operacionRandom,
                codigo: codigoSeguridadRandom, mensaje: mensajeFinal,
                destino: destinoReal, tipo: tipoMovimiento,
                mostrar_celular: mostrarCelular // <--- AÑADIDO PARA OTROS BANCOS
            };

            let movimientos = JSON.parse(localStorage.getItem('yape_movements')) || [];
            movimientos.unshift(nuevoMovimiento);
            localStorage.setItem('yape_movements', JSON.stringify(movimientos));

            setTimeout(() => {
                // SE AÑADE EL PARÁMETRO &mostrar_celular PARA EL EXITO.HTML
                let url = `exito.html?monto=${montoFinal}&nombre=${encodeURIComponent(nombreFinal)}&destino=${encodeURIComponent(destinoReal)}&es_qr=${esQrLogica}&numero=${rawNumber}&mensaje=${encodeURIComponent(mensajeFinal)}&operacion=${operacionRandom}&codigo=${codigoSeguridadRandom}&fecha=${dateTime.date.replace(/\./g,'')}&hora=${dateTime.time.replace(/\./g,'')}&mostrar_celular=${mostrarCelular}`;
                
                if (tipoMovimiento === 'ingreso') url += '&tipo=ingreso';
                window.location.href = url;
            }, 3000);
        });
    </script>
</body>
</html>