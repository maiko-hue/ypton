<!DOCTYPE html>
<html lang="es">
<head>
    <script type="module" src="seguridad.js"></script>
    <script>
    if (!localStorage.getItem('sesion_iniciada')) {
        window.location.href = 'index.html';
    }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yapear Monto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --brand-purple: #742284; --brand-lilac: #bfaec4; --brand-active-lilac: #a86cc1; --brand-teal: #00BFA5; --text-gray: #666; --bg-gray: #f9f9f9; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { width: 100%; height: 100dvh; overflow: hidden; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: white; color: #333; }
        .container { width: 100%; height: 100dvh; display: flex; flex-direction: column; position: relative; background-color: white; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; flex-shrink: 0; }
        .back-btn { display: flex; align-items: center; text-decoration: none; color: #444; font-weight: 700; font-size: 17px; }
        .back-btn i { margin-right: 10px; color: #666; font-size: 18px; }
        .close-btn { color: #666; font-size: 26px; text-decoration: none; font-weight: bold; }
        .content { flex: 1; display: flex; flex-direction: column; align-items: center; padding-top: 20px; overflow-y: auto; min-height: 0; }
        .recipient-name { font-size: 22px; font-weight: 700; color: var(--brand-purple); border: none; text-align: center; background: transparent; width: 100%; margin-bottom: 2px; font-family: inherit; }
        .recipient-number { font-size: 15px; color: #888; font-weight: 600; margin-bottom: 40px; letter-spacing: 1px; }
        .amount-wrapper { display: flex; align-items: center; justify-content: center; margin-bottom: 15px; width: 100%; }
        .currency-symbol { font-size: 45px; font-weight: 500; color: var(--brand-lilac); margin-right: 5px; margin-bottom: 8px; transition: color 0.3s ease; }
        .amount-input { font-size: 85px; font-weight: 500; color: var(--brand-purple); border: none; width: 1ch; text-align: left; background: transparent; font-family: inherit; line-height: 1; padding: 0; caret-color: var(--brand-purple); }
        .amount-input::placeholder { color: var(--brand-purple); opacity: 0.3; }
        .limit-text { background-color: #f4f4f4; color: #888; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; text-align: center; margin: 0 20px 20px 20px; }
        .bottom-section { width: 100%; padding-bottom: max(60px, env(safe-area-inset-bottom)); flex-shrink: 0; background-color: white; z-index: 10; }
        .message-container { width: 100%; padding: 0 25px; position: relative; }
        .message-input { width: 100%; border: none; text-align: center; font-size: 16px; color: #333; font-family: inherit; padding-bottom: 15px; background: transparent; }
        .message-input::placeholder { color: #aaa; }
        .divider-line { width: 90%; height: 1px; background-color: #e0e0e0; margin: 0 auto 20px auto; }
        .footer { padding: 0 20px; display: flex; gap: 15px; background-color: white; }
        .btn { flex: 1; padding: 16px; border-radius: 8px; font-weight: 700; font-size: 16px; cursor: pointer; text-align: center; border: none; transition: all 0.2s; }
        .btn-outline { background-color: white; border: 1px solid var(--brand-teal); color: var(--brand-teal); }
        .btn-primary { background-color: #e0e0e0; color: white; pointer-events: none; }
        .btn-primary.active { background-color: var(--brand-teal); color: white; pointer-events: all; box-shadow: 0 4px 12px rgba(0, 191, 165, 0.3); }
        .btn-primary.active:active { transform: scale(0.98); }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background-color: rgba(0,0,0,0.6); z-index: 3000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .loader-overlay.show { opacity: 1; pointer-events: all; }
        .loader-card { background: white; width: 273px; height: 117px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .custom-spinner { width: 38px; height: 38px; border: 4px solid #e0e0e0; border-top: 4px solid var(--brand-teal); border-radius: 50%; animation: spin 1.5s linear infinite; margin-bottom: 12px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-text { font-size: 16px; font-weight: 700; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="yapear.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> Yapear a</a>
            <a href="inicio.html" class="close-btn"><i class="fa-solid fa-xmark"></i></a>
        </div>
        <div class="content">
            <input type="text" id="recipientName" class="recipient-name" value="" placeholder="Cargando..." spellcheck="false">
            <div class="recipient-number" id="maskedNumber">*** *** ...</div>
            <div class="amount-wrapper">
                <span class="currency-symbol" id="currencySymbol">S/</span>
                <input type="text" id="amountInput" class="amount-input" placeholder="0" maxlength="7" inputmode="decimal">
            </div>
            <div class="limit-text">Límite por yapeo S/500, límite por día S/2,000</div>
        </div>
        <div class="bottom-section">
            <div class="message-container"><input type="text" class="message-input" placeholder="Agregar mensaje"></div>
            <div class="divider-line"></div>
            <div class="footer">
                <button class="btn btn-outline">Otros bancos</button>
                <button class="btn btn-primary" id="yapearBtn">Yapear</button>
            </div>
        </div>
    </div>
    <div class="loader-overlay" id="loaderModal">
        <div class="loader-card"><div class="custom-spinner"></div><div class="loader-text">Yapeando...</div></div>
    </div>

    <script type="module">
        import { db, doc, getDoc } from './firebase.js';

        const params = new URLSearchParams(window.location.search);
        let rawNumber = params.get('numero');
        let passedName = params.get('nombre');
        let qrData = params.get('qr_data');

        const maskedNumberEl = document.getElementById('maskedNumber');
        const nameInput = document.getElementById('recipientName');

        // CARGA DE DATOS
        async function loadContactData() {
            // SI ES QR
            if (qrData) {
                try {
                    const safeId = qrData.replace(/\//g, '_slash_');
                    const docRef = doc(db, "codigos_qr", safeId);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        nameInput.value = data.nombre;
                        // AQUÍ SE MUESTRA EL DESTINO REAL (Plin, Bim, BBVA...)
                        maskedNumberEl.textContent = data.destino || "Yape"; 
                    } else {
                        nameInput.value = "Negocio QR";
                        maskedNumberEl.textContent = "Yape";
                    }
                } catch (error) {
                    nameInput.value = "Error QR";
                }
                return;
            }
            // SI ES NUMERO
            if (!rawNumber) rawNumber = "999999999";
            const lastThree = rawNumber.slice(-3);
            maskedNumberEl.textContent = `*** *** ${lastThree}`;

            if (passedName) {
                nameInput.value = decodeURIComponent(passedName);
            } else {
                try {
                    const docRef = doc(db, "usuarios_yape", rawNumber);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) nameInput.value = docSnap.data().nombre;
                    else nameInput.value = "Desconocido";
                } catch (error) { nameInput.value = "Error de Red"; }
            }
        }
        loadContactData();

        // INTERFAZ
        const amountInput = document.getElementById('amountInput');
        const yapearBtn = document.getElementById('yapearBtn');
        const currencySymbol = document.getElementById('currencySymbol');
        const loaderModal = document.getElementById('loaderModal');

        function getCurrentDateTime() {
            const now = new Date();
            const dateOptions = { day: 'numeric', month: 'short', year: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
            let dateStr = now.toLocaleDateString('es-ES', dateOptions);
            if (!dateStr.endsWith('.')) {
                const parts = dateStr.split(' ');
                if(parts.length >= 2 && !parts[1].includes('.')) parts[1] += '.';
                dateStr = parts.join(' ');
            }
            let timeStr = now.toLocaleTimeString('en-US', timeOptions).toLowerCase().replace('pm', 'p. m.').replace('am', 'a. m.');
            return { date: dateStr, time: timeStr, full: `${dateStr} - ${timeStr}` };
        }

        amountInput.addEventListener('input', function(e) {
            let val = e.target.value.replace(/[^0-9.]/g, ''); 
            if ((val.match(/\./g) || []).length > 1) val = val.substring(0, val.length - 1);
            if (val.length > 1 && val.startsWith('0') && val[1] !== '.') val = val.substring(1);
            let numVal = parseFloat(val);
            if (numVal > 500) val = "500";
            e.target.value = val;
            if (val === "") e.target.style.width = "1ch";
            else e.target.style.width = val.length + "ch";
            if (val.length > 0 && parseFloat(val) > 0) {
                yapearBtn.classList.add('active'); currencySymbol.style.color = '#a86cc1';
            } else {
                yapearBtn.classList.remove('active'); currencySymbol.style.color = '#bfaec4';
            }
        });

        yapearBtn.addEventListener('click', () => {
            loaderModal.classList.add('show');

            const montoFinal = amountInput.value;
            const nombreFinal = nameInput.value;
            const mensajeInput = document.querySelector('.message-input'); 
            const mensajeFinal = mensajeInput ? mensajeInput.value : '';
            const dateTime = getCurrentDateTime();
            const operacionRandom = Math.floor(10000000 + Math.random() * 90000000).toString();
            const codigoSeguridadRandom = Math.floor(100 + Math.random() * 900).toString();

            // --- LÓGICA CRÍTICA PARA EL DESTINO ---
            let destinoReal = "Yape";
            let esQrLogica = "false";

            if (qrData) {
                // Si hay datos QR, el destino es lo que diga la pantalla (Plin, Bim, etc)
                destinoReal = maskedNumberEl.textContent;
                esQrLogica = "true";
            } else {
                // Si es número, siempre es Yape
                destinoReal = "Yape";
                esQrLogica = "false";
            }

            // Truco Auto
            let tipoMovimiento = 'gasto';
            if (mensajeFinal.trim() === "Auto") tipoMovimiento = 'ingreso';

            // Restar Saldo
            let saldoActual = localStorage.getItem('yape_balance');
            if(!saldoActual) saldoActual = "1200.00"; 
            let saldoNumerico = parseFloat(saldoActual.replace(/,/g, ''));
            let montoRestar = parseFloat(montoFinal);
            if (!isNaN(saldoNumerico) && !isNaN(montoRestar)) {
                if(tipoMovimiento === 'ingreso') saldoNumerico += montoRestar;
                else saldoNumerico -= montoRestar;
                localStorage.setItem('yape_balance', saldoNumerico.toFixed(2));
            }

            // Guardar Historial
            const nuevoMovimiento = {
                nombre: nombreFinal,
                monto: montoFinal,
                fecha: dateTime.full,
                fechaSolo: dateTime.date,
                horaSolo: dateTime.time,
                numero: esQrLogica === "true" ? destinoReal : rawNumber,
                operacion: operacionRandom,
                codigo: codigoSeguridadRandom,
                mensaje: mensajeFinal,
                destino: destinoReal, 
                tipo: tipoMovimiento
            };

            let movimientos = JSON.parse(localStorage.getItem('yape_movements')) || [];
            movimientos.unshift(nuevoMovimiento);
            localStorage.setItem('yape_movements', JSON.stringify(movimientos));

            setTimeout(() => {
                // ENVÍO DE PARÁMETROS CORREGIDO
                let url = `exito.html?monto=${montoFinal}&nombre=${encodeURIComponent(nombreFinal)}&destino=${encodeURIComponent(destinoReal)}&es_qr=${esQrLogica}&numero=${rawNumber}&mensaje=${encodeURIComponent(mensajeFinal)}&operacion=${operacionRandom}&codigo=${codigoSeguridadRandom}&fecha=${dateTime.date.replace(/\./g,'')}&hora=${dateTime.time.replace(/\./g,'')}`;
                
                if (tipoMovimiento === 'ingreso') url += '&tipo=ingreso';
                window.location.href = url;
            }, 3000);
        });
    </script>
</body>
</html>