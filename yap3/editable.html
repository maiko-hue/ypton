<!DOCTYPE html>
<html lang="es">
<head>
    <script type="module" src="seguridad.js"></script>
    <script>
    if (!localStorage.getItem('sesion_iniciada')) {
        window.location.href = 'index.html';
    }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yapear Editable</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --brand-purple: #742284;
            --brand-lilac-inactive: #bfaec4;
            --bg-app: #f0f1f3;
            --text-dark: #333;
            --input-bg: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-dark);
            min-height: 100dvh;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: var(--brand-purple);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            height: 60px;
            flex-shrink: 0;
        }

        .back-btn {
            position: absolute;
            left: 20px;
            color: white;
            font-size: 20px;
            text-decoration: none;
            background: none; border: none; cursor: pointer;
        }

        .header-title { font-size: 18px; font-weight: 500; }

        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .custom-input {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 16px;
            font-size: 15px;
            color: #555;
            font-family: inherit;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .custom-input:focus { border-color: #ddd; }
        .custom-input::placeholder { color: #aaa; }
        
        .custom-input:disabled {
            background-color: #e9ecef;
            color: #999;
        }

        .custom-select {
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            margin-top: 5px;
            margin-bottom: 5px;
        }
        
        .checkbox-label { font-size: 14px; color: #333; margin-left: 10px; font-weight: 400; }

        input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--brand-purple); cursor: pointer; }

        /* --- NUEVO: SWITCH CENSURAR --- */
        .censor-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 5px;
            margin-top: -5px; /* Pegadito al input de nombre */
            margin-bottom: 5px;
        }
        .censor-text { font-size: 14px; color: #666; }
        
        .toggle-switch {
            width: 40px; height: 22px; background: #ccc; border-radius: 20px; position: relative; transition: background 0.3s; cursor: pointer;
        }
        .toggle-switch.active { background: var(--brand-purple); }
        .toggle-knob {
            width: 18px; height: 18px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: left 0.3s;
        }
        .toggle-switch.active .toggle-knob { left: 20px; }


        .datetime-container { display: none; gap: 10px; margin-bottom: 10px; }
        .datetime-container.show { display: flex; }

        .amount-container {
            background-color: white;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .currency-symbol { font-size: 28px; color: var(--brand-purple); font-weight: 500; margin-right: 10px; }
        .amount-input { border: none; font-size: 32px; width: 100%; outline: none; color: #555; font-weight: 400; }

        .helper-text { font-size: 12px; color: #777; margin-bottom: 10px; }

        .operation-row { display: flex; gap: 10px; align-items: center; }
        
        .btn-regenerate {
            background-color: #6a1b9a;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0 20px;
            height: 52px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        .btn-regenerate:disabled {
            background-color: #ccc;
            cursor: default;
        }

        .disclaimer { font-size: 11px; color: #888; line-height: 1.3; margin-top: 5px; }

        .footer { padding: 20px; background-color: var(--bg-app); }

        .yapear-btn {
            width: 100%;
            background-color: var(--brand-lilac-inactive); 
            color: white;
            border: none;
            padding: 16px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            pointer-events: none;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .yapear-btn.active {
            background-color: var(--brand-purple);
            pointer-events: all;
            box-shadow: 0 4px 10px rgba(116, 34, 132, 0.4);
        }
        .yapear-btn.active:active { transform: scale(0.98); }

    </style>
</head>
<body>

    <div class="header">
        <button class="back-btn" onclick="window.location.href='inicio.html'">
            <i class="fa-solid fa-chevron-left"></i>
        </button>
        <div class="header-title">Yapear a</div>
    </div>

    <div class="content">
        <input type="text" class="custom-input" id="inpNombre" placeholder="Nombre y Apellido" value="">

        <div class="censor-container">
            <span class="censor-text">Censurar nombre (*)</span>
            <div class="toggle-switch active" id="toggleCensor">
                <div class="toggle-knob"></div>
            </div>
        </div>

        <input type="tel" class="custom-input" id="inpCelular" placeholder="Celular" maxlength="9" value="">

        <select class="custom-input custom-select" id="bankSelect">
            <option value="Yape">Yape</option>
            <option value="Plin">Plin</option>
            <option value="IziPay">IziPay</option>
        </select>

        <input type="text" class="custom-input" id="inpMensaje" placeholder="Agregar mensaje (opcional)">

        <div class="checkbox-row">
            <input type="checkbox" id="checkFecha">
            <label for="checkFecha" class="checkbox-label">Elegir fecha y hora manualmente</label>
        </div>

        <div class="datetime-container" id="dateInputs">
            <input type="date" class="custom-input" id="customDate">
            <input type="time" class="custom-input" id="customTime">
        </div>

        <div class="amount-container">
            <span class="currency-symbol">S/</span>
            <input type="number" class="amount-input" id="inpMonto" placeholder="500" value="">
        </div>
        <div class="helper-text">Puedes Yapear hasta S/500 diarios</div>

        <div class="checkbox-row">
            <input type="checkbox" id="checkOp" checked>
            <label for="checkOp" class="checkbox-label">Ingresar N° de operación manualmente</label>
        </div>

        <div class="operation-row">
            <input type="number" class="custom-input" id="opInput" value="01334523">
            <button class="btn-regenerate" id="regenBtn">Regenerar</button>
        </div>

        <div class="disclaimer">
            Se usará como "Nro. de operación". En Yape, el "Código de seguridad" son los 3 últimos dígitos.
        </div>
    </div>

    <div class="footer">
        <button class="yapear-btn" id="btnFinalYapear">Yapear</button>
    </div>

    <script>
        // --- Referencias ---
        const inpNombre = document.getElementById('inpNombre');
        const inpCelular = document.getElementById('inpCelular');
        const inpMonto = document.getElementById('inpMonto');
        const btnFinalYapear = document.getElementById('btnFinalYapear');
        
        const checkOp = document.getElementById('checkOp');
        const opInput = document.getElementById('opInput');
        const regenBtn = document.getElementById('regenBtn');

        const checkFecha = document.getElementById('checkFecha');
        const dateInputs = document.getElementById('dateInputs');
        const customDate = document.getElementById('customDate');
        const customTime = document.getElementById('customTime');

        // Toggle Censura
        const toggleCensor = document.getElementById('toggleCensor');
        let isCensorActive = true; // Por defecto activado

        toggleCensor.addEventListener('click', () => {
            isCensorActive = !isCensorActive;
            if(isCensorActive) {
                toggleCensor.classList.add('active');
            } else {
                toggleCensor.classList.remove('active');
            }
        });

        // --- Inicialización Fecha/Hora ---
        const now = new Date();
        customDate.valueAsDate = now;
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        customTime.value = `${hours}:${minutes}`;

        // --- Validar Botón "Yapear" (Color Saturado) ---
        function validateForm() {
            const hasName = inpNombre.value.trim().length > 0;
            const hasCell = inpCelular.value.length === 9; 
            const hasAmount = inpMonto.value.trim().length > 0 && parseFloat(inpMonto.value) > 0;

            if (hasName && hasCell && hasAmount) {
                btnFinalYapear.classList.add('active');
            } else {
                btnFinalYapear.classList.remove('active');
            }
        }

        // --- Eventos de Inputs para validación ---
        inpNombre.addEventListener('input', validateForm);
        inpMonto.addEventListener('input', validateForm);
        
        inpCelular.addEventListener('input', function(e) {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 9) val = val.slice(0, 9);
            e.target.value = val;
            validateForm();
        });

        // --- Lógica Checkbox Operación ---
        checkOp.addEventListener('change', () => {
            if(checkOp.checked) {
                opInput.disabled = false;
                regenBtn.disabled = false;
            } else {
                opInput.disabled = true;
                regenBtn.disabled = true;
            }
        });

        // --- Lógica Checkbox Fecha ---
        checkFecha.addEventListener('change', () => {
            if(checkFecha.checked) {
                dateInputs.classList.add('show');
            } else {
                dateInputs.classList.remove('show');
            }
        });

        // --- Generar Operación ---
        opInput.value = Math.floor(10000000 + Math.random() * 90000000);
        regenBtn.addEventListener('click', () => {
            const randomOp = Math.floor(10000000 + Math.random() * 90000000);
            opInput.value = randomOp;
        });

        // --- Acción del Botón Yapear ---
        btnFinalYapear.addEventListener('click', () => {
            const nombre = inpNombre.value;
            const numero = inpCelular.value;
            const destino = document.getElementById('bankSelect').value;
            const mensaje = document.getElementById('inpMensaje').value;
            const monto = inpMonto.value;
            const operacion = opInput.value; 

            let fechaStr = "";
            let horaStr = "";
            
            if(checkFecha.checked) {
                fechaStr = customDate.value; 
                horaStr = customTime.value; 
            }

            // AÑADIDO: &censurar=true/false
            let url = `exito_editable.html?nombre=${encodeURIComponent(nombre)}&numero=${numero}&destino=${encodeURIComponent(destino)}&monto=${monto}&operacion=${operacion}&mensaje=${encodeURIComponent(mensaje)}&censurar=${isCensorActive}`;

            if(fechaStr && horaStr) {
                url += `&fecha=${fechaStr}&hora=${horaStr}`;
            }

            window.location.href = url;
        });
        
        validateForm();

    </script>
</body>
</html>